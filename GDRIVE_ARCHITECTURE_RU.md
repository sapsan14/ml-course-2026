# Архитектура системы синхронизации с Google Drive

## Схема работы

```
┌─────────────────────────────────────────────────────────────────────┐
│                    ЛОКАЛЬНАЯ ФАЙЛОВАЯ СИСТЕМА                        │
│                                                                       │
│  /home/anton/projects/ml-course-2026/                                │
│  ├── ex1/                                                            │
│  │   ├── *.ipynb                                                     │
│  │   ├── *.py                                                        │
│  │   └── *.md                                                        │
│  ├── ex2/                                                            │
│  │   └── ...                                                         │
│  └── ex3/                                                            │
│      └── ...                                                         │
└───────────────────────────┬─────────────────────────────────────────┘
                            │
                            │ Сканирование и фильтрация
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      СКРИПТ СИНХРОНИЗАЦИИ                            │
│                                                                       │
│  gdrive_sync.py                                                      │
│  ├── Аутентификация (OAuth2)                                        │
│  ├── Чтение конфигурации                                            │
│  ├── Фильтрация файлов                                              │
│  │   ├── По расширениям: .ipynb, .py, .md, .txt                     │
│  │   └── Исключения: .venv, .git, __pycache__                       │
│  ├── Создание структуры папок                                       │
│  └── Загрузка/обновление файлов                                     │
└───────────────────────────┬─────────────────────────────────────────┘
                            │
                            │ Google Drive API v3
                            │ (HTTPS)
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         GOOGLE DRIVE                                 │
│                                                                       │
│  ml-course-2026/                                                     │
│  ├── ex1/                                                            │
│  │   ├── файл1.ipynb                                                │
│  │   ├── файл2.py                                                   │
│  │   └── README.md                                                  │
│  ├── ex2/                                                            │
│  │   └── ...                                                         │
│  └── ex3/                                                            │
│      └── ...                                                         │
└─────────────────────────────────────────────────────────────────────┘
```

## Компоненты системы

```
┌──────────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                                  │
└────────────┬─────────────────────────────────────────────────────────┘
             │
             │ Ручной запуск или автоматический (cron/systemd)
             ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    ТОЧКИ ВХОДА                                        │
│                                                                        │
│  ┌─────────────────┐  ┌──────────────────┐  ┌──────────────────┐    │
│  │ gdrive_sync.py  │  │ check_sync_      │  │ run_sync.sh      │    │
│  │                 │  │ status.py        │  │ (cron wrapper)   │    │
│  │ Синхронизация   │  │ Проверка статуса │  │                  │    │
│  └─────────────────┘  └──────────────────┘  └──────────────────┘    │
└────────────┬─────────────────────────────────────────────────────────┘
             │
             ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    КОНФИГУРАЦИЯ                                       │
│                                                                        │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │
│  │ credentials.json │  │ token.pickle     │  │ gdrive_sync_     │   │
│  │                  │  │                  │  │ config.json      │   │
│  │ OAuth Client ID  │  │ Access Token     │  │ Настройки        │   │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘   │
└────────────┬─────────────────────────────────────────────────────────┘
             │
             ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    GOOGLE DRIVE API                                   │
│                                                                        │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ OAuth 2.0 Authentication                                       │  │
│  ├────────────────────────────────────────────────────────────────┤  │
│  │ Files API                                                      │  │
│  │  ├── files.list()    - Поиск файлов                           │  │
│  │  ├── files.create()  - Создание файлов/папок                  │  │
│  │  ├── files.update()  - Обновление файлов                      │  │
│  │  └── about.get()     - Информация об аккаунте                 │  │
│  └────────────────────────────────────────────────────────────────┘  │
└────────────┬─────────────────────────────────────────────────────────┘
             │
             ▼
┌──────────────────────────────────────────────────────────────────────┐
│                         ЛОГИРОВАНИЕ                                   │
│                                                                        │
│  /tmp/gdrive_sync.log                                                 │
│  ├── Время начала/окончания                                          │
│  ├── Список обработанных файлов                                      │
│  ├── Статус операций (✓ успех, ↑ загружен, ⚠ предупреждение)        │
│  └── Ошибки (если есть)                                              │
└──────────────────────────────────────────────────────────────────────┘
```

## Поток данных при синхронизации

```
START
  │
  ├─► [1] Загрузка конфигурации
  │    └─► gdrive_sync_config.json
  │
  ├─► [2] Аутентификация
  │    ├─► Проверка token.pickle
  │    ├─► Если токен истек → обновление
  │    └─► Если токена нет → OAuth flow с credentials.json
  │
  ├─► [3] Подключение к Google Drive API
  │    └─► Создание service объекта
  │
  ├─► [4] Получение/создание корневой папки
  │    ├─► Поиск папки "ml-course-2026"
  │    └─► Если не найдена → создание
  │
  ├─► [5] Для каждой папки в sync_folders:
  │    │
  │    ├─► [5.1] Создание папки на Drive (если нужно)
  │    │
  │    ├─► [5.2] Сканирование локальной папки
  │    │    └─► Рекурсивный обход всех файлов
  │    │
  │    ├─► [5.3] Фильтрация файлов
  │    │    ├─► Проверка расширения (sync_extensions)
  │    │    └─► Проверка исключений (exclude_patterns)
  │    │
  │    ├─► [5.4] Для каждого файла:
  │    │    │
  │    │    ├─► Создание подпапок (если нужно)
  │    │    │
  │    │    ├─► Поиск файла на Drive
  │    │    │
  │    │    ├─► Если файл существует:
  │    │    │    └─► Обновление (files.update)
  │    │    │
  │    │    └─► Если файл не существует:
  │    │         └─► Создание (files.create)
  │    │
  │    └─► [5.5] Логирование результата
  │
  └─► [6] Завершение
       └─► Вывод итоговой статистики
```

## Автоматизация через Cron

```
┌─────────────────────────────────────────────────────────────────────┐
│                         CRON DAEMON                                  │
│                                                                       │
│  Расписание: */15 * * * *  (каждые 15 минут)                        │
└────────────┬────────────────────────────────────────────────────────┘
             │
             │ Запуск в указанное время
             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      run_sync.sh                                     │
│                                                                       │
│  #!/bin/bash                                                         │
│  cd /home/anton/projects/ml-course-2026                              │
│  source .venv/bin/activate                                           │
│  ./gdrive_sync.py >> /tmp/gdrive_sync.log 2>&1                       │
└────────────┬────────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    gdrive_sync.py                                    │
│                                                                       │
│  Выполнение синхронизации                                           │
└────────────┬────────────────────────────────────────────────────────┘
             │
             │ Вывод перенаправляется в лог
             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  /tmp/gdrive_sync.log                                │
│                                                                       │
│  [2026-02-17 19:15:00] Начало синхронизации                         │
│  [2026-02-17 19:15:01] ✓ Аутентификация успешна                     │
│  [2026-02-17 19:15:02] 📁 Синхронизация: ex1                        │
│  [2026-02-17 19:15:03] ↑ Загружен: ex1/notebook.ipynb               │
│  [2026-02-17 19:15:04] ✓ Синхронизация завершена                    │
└─────────────────────────────────────────────────────────────────────┘
```

## Безопасность и конфиденциальность

```
┌─────────────────────────────────────────────────────────────────────┐
│                    КОНФИДЕНЦИАЛЬНЫЕ ФАЙЛЫ                            │
│                                                                       │
│  credentials.json                                                    │
│  ├── Client ID                                                       │
│  ├── Client Secret                                                   │
│  └── Redirect URIs                                                   │
│                                                                       │
│  token.pickle                                                        │
│  ├── Access Token                                                    │
│  ├── Refresh Token                                                   │
│  └── Token Expiry                                                    │
│                                                                       │
│  gdrive_sync_config.json                                             │
│  └── Google Drive Folder ID                                          │
└────────────┬────────────────────────────────────────────────────────┘
             │
             │ Защита через .gitignore
             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         .gitignore                                   │
│                                                                       │
│  # Google Drive sync                                                 │
│  credentials.json                                                    │
│  token.pickle                                                        │
│  gdrive_sync_config.json                                             │
└─────────────────────────────────────────────────────────────────────┘
```

## Обработка ошибок

```
┌─────────────────────────────────────────────────────────────────────┐
│                      ВОЗМОЖНЫЕ ОШИБКИ                                │
└─────────────────────────────────────────────────────────────────────┘

1. credentials.json не найден
   └─► FileNotFoundError с инструкциями по получению файла

2. Токен истек
   └─► Автоматическое обновление через refresh_token

3. Нет refresh_token
   └─► Запрос новой авторизации через OAuth flow

4. Сетевая ошибка
   └─► Логирование ошибки, повторная попытка при следующем запуске

5. Файл не найден локально
   └─► Предупреждение в логе, пропуск файла

6. Недостаточно места на Drive
   └─► Ошибка с информацией о квоте

7. Неверный формат конфигурации
   └─► Использование конфигурации по умолчанию
```

## Мониторинг и диагностика

```
┌─────────────────────────────────────────────────────────────────────┐
│                   ИНСТРУМЕНТЫ МОНИТОРИНГА                            │
└─────────────────────────────────────────────────────────────────────┘

check_sync_status.py
├─► Проверка авторизации
├─► Информация о Google Drive аккаунте
│   ├── Email
│   ├── Имя
│   └── Использование квоты
├─► Статус конфигурации
│   ├── Папки для синхронизации
│   ├── Расширения файлов
│   └── ID папки на Drive
├─► Локальные папки
│   ├── Существование
│   └── Количество файлов
└─► Логи
    ├── Последнее обновление
    ├── Размер лог-файла
    └── Последние записи
```

---

**Примечание**: Эта диаграмма описывает архитектуру системы синхронизации файлов проекта с Google Drive. Все компоненты работают вместе для обеспечения надежной и безопасной синхронизации.
